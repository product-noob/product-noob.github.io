---
/**
 * SpeakingEvents — Horizontal auto-scrolling card carousel + detail modal.
 * Self-contained: owns its markup, styles, and client-side script.
 */
import { events } from '../../data/events';
---

<section class="events" id="speaking-events">
  <div class="container">
    <div class="events__header">
      <h2 class="events__title">Speaking & Events</h2>
      <p class="events__subtitle">
        Showing up where AI meets product — learning, sharing, and connecting.
      </p>
    </div>
  </div>

  <!-- Horizontal scroll track (full-bleed, overflows container) -->
  <div class="events__viewport">
    <div class="events__track" id="events-track">
      {/* First set */}
      {events.map((event) => (
        <button
          class="event-card"
          data-event-id={event.id}
          type="button"
          aria-label={`View details for ${event.title}`}
        >
          <div class="event-card__image">
            <img
              src={event.thumbnail}
              alt={event.title}
              class="event-card__img"
              width="280"
              height="210"
              loading="lazy"
              decoding="async"
            />
            {event.status === 'upcoming' && (
              <span class="event-card__badge">Upcoming</span>
            )}
          </div>
          <div class="event-card__body">
            <p class="event-card__date">{event.date}</p>
            <h3 class="event-card__title">{event.title}</h3>
            <p class="event-card__tagline">{event.tagline}</p>
          </div>
          <div class="event-card__accent" style={`background: ${event.accentColor};`}></div>
        </button>
      ))}
      {/* Duplicate set for infinite scroll illusion */}
      {events.map((event) => (
        <button
          class="event-card"
          data-event-id={event.id}
          type="button"
          aria-label={`View details for ${event.title}`}
          aria-hidden="true"
        >
          <div class="event-card__image">
            <img
              src={event.thumbnail}
              alt={event.title}
              class="event-card__img"
              width="280"
              height="210"
              loading="lazy"
              decoding="async"
            />
            {event.status === 'upcoming' && (
              <span class="event-card__badge">Upcoming</span>
            )}
          </div>
          <div class="event-card__body">
            <p class="event-card__date">{event.date}</p>
            <h3 class="event-card__title">{event.title}</h3>
            <p class="event-card__tagline">{event.tagline}</p>
          </div>
          <div class="event-card__accent" style={`background: ${event.accentColor};`}></div>
        </button>
      ))}
    </div>
  </div>
</section>

<!-- Event Detail Modal -->
<div class="event-modal" id="event-modal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="event-modal__backdrop" id="modal-backdrop"></div>
  <div class="event-modal__content" id="modal-content">
    <button class="event-modal__close" id="modal-close" aria-label="Close modal">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
        <path d="M18 6L6 18"/><path d="M6 6l12 12"/>
      </svg>
    </button>

    <div class="event-modal__hero" id="modal-hero">
      <img id="modal-hero-img" class="event-modal__hero-img" src="" alt="" width="560" height="245" decoding="async" />
    </div>

    <div class="event-modal__body">
      <div class="event-modal__meta">
        <span class="event-modal__date" id="modal-date"></span>
        <span class="event-modal__status" id="modal-status"></span>
      </div>
      <h3 class="event-modal__title" id="modal-title"></h3>
      <p class="event-modal__desc" id="modal-desc"></p>

      <!-- Key Takeaways (hidden for upcoming events) -->
      <div class="event-modal__section" id="modal-takeaways-section" style="display: none;">
        <h4 class="event-modal__section-title">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
            <path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
          </svg>
          Key Takeaways
        </h4>
        <ul class="event-modal__takeaways" id="modal-takeaways"></ul>
      </div>

      <!-- Photo Gallery (up to 4 photos) -->
      <div class="event-modal__gallery" id="modal-gallery" style="display: none;"></div>
    </div>
  </div>
</div>

<!-- Lightbox Overlay -->
<div class="lightbox" id="lightbox" aria-hidden="true">
  <div class="lightbox__backdrop" id="lightbox-backdrop"></div>
  <button class="lightbox__close" id="lightbox-close" aria-label="Close photo">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
      <path d="M18 6L6 18"/><path d="M6 6l12 12"/>
    </svg>
  </button>
  <img src="" alt="" class="lightbox__img" id="lightbox-img" />
</div>

<!-- Event data (embedded for client-side JS) -->
<script is:inline define:vars={{ eventsJson: JSON.stringify(events) }}>
  (function () {
    const eventData = JSON.parse(eventsJson);
    const modal = document.getElementById('event-modal');
    const backdrop = document.getElementById('modal-backdrop');
    const closeBtn = document.getElementById('modal-close');
    
    // Lightbox elements
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightbox-img');
    const lightboxClose = document.getElementById('lightbox-close');
    const lightboxBackdrop = document.getElementById('lightbox-backdrop');

    // ── Lightbox Logic ──────────────────────────────────────────
    function openLightbox(src, alt) {
      lightboxImg.src = src;
      lightboxImg.alt = alt || '';
      lightbox.setAttribute('aria-hidden', 'false');
      lightbox.classList.add('is-open');
      document.body.style.overflow = 'hidden'; // Ensure scroll is locked
    }

    function closeLightbox() {
      lightbox.classList.remove('is-open');
      lightbox.setAttribute('aria-hidden', 'true');
      // If modal is still open, keep scroll locked
      if (!modal.classList.contains('is-open')) {
        document.body.style.overflow = '';
      }
    }

    // ── Open modal ──────────────────────────────────────────────
    function openModal(eventId) {
      const event = eventData.find(e => e.id === eventId);
      if (!event) return;

      // Hero image
      const heroImg = document.getElementById('modal-hero-img');
      heroImg.src = event.thumbnail;
      heroImg.alt = event.title;

      document.getElementById('modal-title').textContent = event.title;
      document.getElementById('modal-date').textContent = event.date;

      const statusEl = document.getElementById('modal-status');
      statusEl.textContent = event.status === 'upcoming' ? 'Upcoming' : 'Attended';
      statusEl.className = 'event-modal__status' +
        (event.status === 'upcoming' ? ' event-modal__status--upcoming' : ' event-modal__status--attended');

      document.getElementById('modal-desc').textContent = event.modal.description;

      // Key Takeaways — only show for attended events with takeaways
      const takeawaysSection = document.getElementById('modal-takeaways-section');
      const takeawaysList = document.getElementById('modal-takeaways');
      if (event.status === 'attended' && event.modal.takeaways && event.modal.takeaways.length > 0) {
        takeawaysList.innerHTML = event.modal.takeaways
          .map(function(t) { return '<li>' + t + '</li>'; })
          .join('');
        takeawaysSection.style.display = '';
      } else {
        takeawaysSection.style.display = 'none';
        takeawaysList.innerHTML = '';
      }

      // Photo Gallery — up to 4 photos
      var gallery = document.getElementById('modal-gallery');
      var photos = event.modal.photos || [];
      if (photos.length > 0) {
        var max = Math.min(photos.length, 4);
        gallery.innerHTML = '';
        gallery.setAttribute('data-count', max);
        for (var i = 0; i < max; i++) {
          var img = document.createElement('img');
          img.src = photos[i];
          img.alt = event.title + ' photo ' + (i + 1);
          img.className = 'event-modal__gallery-img';
          img.loading = 'lazy';
          // Add click listener for lightbox
          (function(src, alt) {
             img.addEventListener('click', function() {
               openLightbox(src, alt);
             });
          })(photos[i], event.title + ' photo ' + (i + 1));
          
          gallery.appendChild(img);
        }
        gallery.style.display = '';
      } else {
        gallery.style.display = 'none';
        gallery.innerHTML = '';
      }

      modal.setAttribute('aria-hidden', 'false');
      modal.classList.add('is-open');
      document.body.style.overflow = 'hidden';
    }

    // ── Close modal ─────────────────────────────────────────────
    function closeModal() {
      modal.classList.remove('is-open');
      modal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
    }

    // ── Event listeners ─────────────────────────────────────────
    document.querySelectorAll('.event-card').forEach(function(card) {
      card.addEventListener('click', function() { openModal(card.dataset.eventId); });
    });

    if (closeBtn) closeBtn.addEventListener('click', closeModal);
    if (backdrop) backdrop.addEventListener('click', closeModal);
    
    // Lightbox listeners
    if (lightboxClose) lightboxClose.addEventListener('click', closeLightbox);
    // When clicking backdrop, close lightbox
    if (lightboxBackdrop) lightboxBackdrop.addEventListener('click', closeLightbox);

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        if (lightbox.classList.contains('is-open')) {
          closeLightbox();
        } else if (modal.classList.contains('is-open')) {
          closeModal();
        }
      }
    });

    // ── Scroll-reveal animation ─────────────────────────────────
    if ('IntersectionObserver' in window) {
      var section = document.getElementById('speaking-events');
      if (section) {
        var observer = new IntersectionObserver(
          function(entries) {
            entries.forEach(function(entry) {
              if (entry.isIntersecting) {
                entry.target.classList.add('is-visible');
                observer.unobserve(entry.target);
              }
            });
          },
          { threshold: 0.15, rootMargin: '0px 0px -10% 0px' }
        );
        observer.observe(section);
      }
    }
  })();
</script>

<style>
  /* ================================================================
     Section
     ================================================================ */
  .events {
    padding: var(--space-16) 0 var(--space-24);
    position: relative;
    opacity: 0;
    transform: translateY(24px);
    transition: opacity 0.7s ease, transform 0.7s ease;
  }

  .events.is-visible {
    opacity: 1;
    transform: translateY(0);
  }

  /* ================================================================
     Header
     ================================================================ */
  .events__header {
    text-align: center;
    max-width: 600px;
    margin: 0 auto var(--space-12);
  }

  .events__title {
    font-family: var(--font-display);
    font-size: var(--text-4xl);
    font-weight: 700;
    color: var(--gray-900);
    margin-bottom: var(--space-4);
  }

  @media (min-width: 768px) {
    .events__title {
      font-size: var(--text-5xl);
    }
  }

  .events__subtitle {
    font-size: var(--text-base);
    color: var(--gray-500);
    line-height: 1.6;
    margin: 0;
  }

  /* ================================================================
     Carousel viewport and track
     ================================================================ */
  .events__viewport {
    overflow: hidden;
    width: 100%;
    mask-image: linear-gradient(
      to right,
      transparent 0%,
      black 8%,
      black 92%,
      transparent 100%
    );
    -webkit-mask-image: linear-gradient(
      to right,
      transparent 0%,
      black 8%,
      black 92%,
      transparent 100%
    );
  }

  .events__track {
    display: flex;
    gap: var(--space-6);
    padding: var(--space-4) var(--space-6);
    animation: scrollTrack 30s linear infinite;
    width: max-content;
  }

  .events__track:hover {
    animation-play-state: paused;
  }

  @keyframes scrollTrack {
    0% {
      transform: translateX(0);
    }
    100% {
      transform: translateX(-50%);
    }
  }

  /* ================================================================
     Event card
     ================================================================ */
  .event-card {
    flex-shrink: 0;
    width: 280px;
    background: white;
    border-radius: var(--radius-xl);
    border: 1px solid var(--gray-200);
    overflow: hidden;
    cursor: pointer;
    transition: all 0.35s cubic-bezier(0.16, 1, 0.3, 1);
    position: relative;
    display: flex;
    flex-direction: column;
    text-align: left;
    padding: 0;
    font-family: inherit;
    box-shadow: var(--shadow-card);
  }

  .event-card:hover {
    transform: translateY(-6px);
    box-shadow: var(--shadow-card-hover);
    border-color: var(--gray-300);
  }

  /* Top accent bar */
  .event-card__accent {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    border-radius: var(--radius-xl) var(--radius-xl) 0 0;
  }

  /* Thumbnail area */
  .event-card__image {
    aspect-ratio: 4 / 3;
    position: relative;
    overflow: hidden;
    background: var(--gray-100);
  }

  .event-card__img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.45s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .event-card:hover .event-card__img {
    transform: scale(1.06);
  }

  /* "Upcoming" badge */
  .event-card__badge {
    position: absolute;
    top: var(--space-3);
    right: var(--space-3);
    padding: var(--space-1) var(--space-3);
    background: linear-gradient(135deg, var(--color-accent), var(--color-accent-secondary));
    color: white;
    font-size: var(--text-2xs);
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    border-radius: var(--radius-full);
    box-shadow: var(--shadow-md);
    z-index: 2;
  }

  /* Card body */
  .event-card__body {
    padding: var(--space-5);
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    flex-grow: 1;
  }

  .event-card__date {
    font-size: var(--text-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--gray-400);
    margin: 0;
  }

  .event-card__title {
    font-family: var(--font-display);
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--gray-900);
    margin: 0;
    line-height: 1.3;
  }

  .event-card__tagline {
    font-size: var(--text-xs);
    color: var(--gray-500);
    line-height: 1.5;
    margin: 0;
  }

  /* ================================================================
     Modal
     ================================================================ */
  .event-modal {
    position: fixed;
    inset: 0;
    z-index: 999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-4);
    pointer-events: none;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }

  .event-modal.is-open {
    pointer-events: auto;
    opacity: 1;
    visibility: visible;
  }

  .event-modal__backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(var(--space-2));
    -webkit-backdrop-filter: blur(var(--space-2));
  }

  .event-modal__content {
    position: relative;
    width: 100%;
    max-width: 560px;
    max-height: 85vh;
    overflow-y: auto;
    background: white;
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-xl);
    transform: scale(0.95) translateY(12px);
    transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .event-modal.is-open .event-modal__content {
    transform: scale(1) translateY(0);
  }

  /* Custom scrollbar for the modal */
  .event-modal__content::-webkit-scrollbar {
    width: 6px;
  }

  .event-modal__content::-webkit-scrollbar-track {
    background: transparent;
  }

  .event-modal__content::-webkit-scrollbar-thumb {
    background: var(--gray-300);
    border-radius: 3px;
  }

  /* Close button */
  .event-modal__close {
    position: absolute;
    top: var(--space-3);
    right: var(--space-3);
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: var(--radius-full);
    border: none;
    background: var(--glass-bg-heavy);
    backdrop-filter: blur(var(--space-2));
    -webkit-backdrop-filter: blur(var(--space-2));
    cursor: pointer;
    color: var(--gray-600);
    box-shadow: var(--shadow-md);
    transition: all 0.2s ease;
  }

  .event-modal__close:hover {
    background: white;
    color: var(--gray-900);
    transform: scale(1.1);
  }

  /* Hero image area */
  .event-modal__hero {
    aspect-ratio: 16 / 7;
    overflow: hidden;
    border-radius: var(--radius-xl) var(--radius-xl) 0 0;
    background: var(--gray-100);
  }

  .event-modal__hero-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Modal body */
  .event-modal__body {
    padding: var(--space-6) var(--space-8) var(--space-8);
  }

  .event-modal__meta {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-3);
  }

  .event-modal__date {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--gray-500);
    text-transform: uppercase;
    letter-spacing: 0.06em;
  }

  .event-modal__status {
    display: inline-flex;
    padding: var(--space-1) var(--space-2);
    font-size: var(--text-2xs);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    border-radius: var(--radius-full);
  }

  .event-modal__status--attended {
    background: #ecfdf5;
    color: #059669;
  }

  .event-modal__status--upcoming {
    background: linear-gradient(135deg, var(--color-accent), var(--color-accent-secondary));
    color: white;
  }

  .event-modal__title {
    font-family: var(--font-display);
    font-size: var(--text-2xl);
    font-weight: 700;
    color: var(--gray-900);
    margin-bottom: var(--space-4);
    line-height: 1.2;
  }

  .event-modal__desc {
    font-size: var(--text-sm);
    color: var(--gray-600);
    line-height: 1.7;
    margin-bottom: var(--space-6);
  }

  /* Takeaways section */
  .event-modal__section {
    background: var(--gray-50);
    border-radius: var(--radius-lg);
    padding: var(--space-5) var(--space-6);
    border: 1px solid var(--gray-100);
    margin-bottom: var(--space-6);
  }

  .event-modal__section-title {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-family: var(--font-display);
    font-size: var(--text-sm);
    font-weight: 700;
    color: var(--gray-900);
    margin-bottom: var(--space-4);
  }

  .event-modal__section-title svg {
    color: var(--color-accent);
  }

  .event-modal__takeaways {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .event-modal__takeaways li {
    position: relative;
    padding-left: var(--space-5);
    font-size: var(--text-xs);
    color: var(--gray-600);
    line-height: 1.6;
  }

  .event-modal__takeaways li::before {
    content: '';
    position: absolute;
    left: 0;
    top: 7px;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--color-accent);
    opacity: 0.7;
  }

  /* ================================================================
     Photo Gallery — responsive grid, supports 1–4 photos
     ================================================================ */
  .event-modal__gallery {
    display: grid;
    gap: var(--space-3);
    border-radius: var(--radius-lg);
    overflow: hidden;
  }

  /* 1 photo — full width */
  .event-modal__gallery[data-count="1"] {
    grid-template-columns: 1fr;
  }

  /* 2 photos — side by side */
  .event-modal__gallery[data-count="2"] {
    grid-template-columns: 1fr 1fr;
  }

  /* 3 photos — first full width, two below */
  .event-modal__gallery[data-count="3"] {
    grid-template-columns: 1fr 1fr;
  }

  .event-modal__gallery[data-count="3"] :global(.event-modal__gallery-img:first-child) {
    grid-column: 1 / -1;
  }

  /* 4 photos — 2×2 grid */
  .event-modal__gallery[data-count="4"] {
    grid-template-columns: 1fr 1fr;
  }

  :global(.event-modal__gallery-img) {
    width: 100%;
    aspect-ratio: 3 / 2;
    object-fit: cover;
    border-radius: var(--radius-md);
    border: 1px solid var(--gray-100);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    cursor: zoom-in;
  }

  :global(.event-modal__gallery-img:hover) {
    transform: scale(1.02);
    box-shadow: var(--shadow-md);
  }

  /* ================================================================
     Lightbox
     ================================================================ */
  .lightbox {
    position: fixed;
    inset: 0;
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-4);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }

  .lightbox.is-open {
    opacity: 1;
    pointer-events: auto;
  }

  .lightbox__backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(var(--space-2));
    -webkit-backdrop-filter: blur(var(--space-2));
  }

  .lightbox__img {
    position: relative;
    max-width: 100%;
    max-height: 90vh;
    border-radius: var(--radius-md);
    box-shadow: 0 0 40px rgba(0, 0, 0, 0.5);
    transform: scale(0.95);
    transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .lightbox.is-open .lightbox__img {
    transform: scale(1);
  }

  .lightbox__close {
    position: absolute;
    top: var(--space-6);
    right: var(--space-6);
    z-index: 10;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .lightbox__close:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.1);
  }

  /* ================================================================
     Responsive
     ================================================================ */
  @media (max-width: 767px) {
    .events {
      padding: var(--space-12) 0 var(--space-16);
    }

    .events__header {
      margin-bottom: var(--space-8);
      padding: 0 var(--space-4);
    }

    .event-card {
      width: 240px;
    }

    .events__track {
      gap: var(--space-4);
      padding: var(--space-3) var(--space-4);
    }

    .event-modal__body {
      padding: var(--space-5) var(--space-5) var(--space-6);
    }

    .event-modal__title {
      font-size: var(--text-xl);
    }

    .event-modal__content {
      max-height: 90vh;
    }
    
    .lightbox__close {
      top: var(--space-4);
      right: var(--space-4);
      width: 40px;
      height: 40px;
    }
  }

  /* ================================================================
     Reduced motion
     ================================================================ */
  @media (prefers-reduced-motion: reduce) {
    .events {
      opacity: 1;
      transform: none;
      transition: none;
    }

    .events__track {
      animation: none;
    }

    .event-card {
      transition: none;
    }

    .event-modal,
    .event-modal__content,
    .lightbox, 
    .lightbox__img {
      transition: none;
    }
  }
</style>
